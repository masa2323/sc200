質問7 トピック1

Microsoft 365 E5 サブスクリプションをご利用です。Microsoft 365 Defender を使用してクロスドメイン調査を実施する予定です。  
悪意のあるメール添付ファイルの影響を受けるデバイスを特定するための高度なハンティングクエリを作成する必要があります。  
クエリはどのように完成させるべきでしょうか？回答するには、回答エリアで適切なオプションを選択してください。  
注: 正解は1つにつき1ポイントです。  
ホットエリア:  
![](https://www.examtopics.com/assets/media/exam-media/04261/0001800001.png)  

**正解:** ![](https://www.examtopics.com/assets/media/exam-media/04261/0001900001.png) 参照:  
<https://docs.microsoft.com/en-us/microsoft-365/security/mtp/advanced-hunting-query-emails-devices?view=o365-worldwide>

**解説:**
このクエリは、「メールのデータ」と「デバイス上のファイル操作データ」という 2 つの異なるドメインを結合して調査する、クロスドメインクエリの典型的な構成です。

1. `join`（1 番目のドロップダウン）

`EmailAttachmentInfo` テーブル（メールの添付ファイル情報）と `DeviceFileEvents` テーブル（デバイス上のファイル操作情報）を関連付けるには、共通のキー（今回は `SHA256` ハッシュ値）を使用してテーブルを結合する必要があります。そのため、**`join`** 演算子を使用します。

2. `project`（2 番目のドロップダウン）

`join` の括弧内にある `DeviceFileEvents` から、結合に必要な `SHA256` と、後で表示したい `FileName` だけを抽出しています。このように、特定の列のみを選択（投影）する演算子は **`project`** です。結合前に列を絞り込むことは、クエリのパフォーマンス向上にも繋がります。

3. `project`（3 番目のドロップダウン）

クエリの最後で、最終的に表示したい列（タイムスタンプ、デバイス名、受信者アドレスなど）をリストアップしています。ここでも、出力結果に含める列を指定するために **`project`** 演算子を使用します。

質問#38 トピック1
  
Microsoft 365 E5 サブスクリプションをお持ちです。
Document.pdf という添付ファイルを含むすべてのメールを返すハンティングクエリを作成する必要があります。クエリは以下の要件を満たす必要があります。  
  
• 過去 1 時間以内に送信されたメールのみを表示する。  
• クエリのパフォーマンスを最適化する。  
  
クエリをどのように完了すればよいですか？回答するには、回答エリアで適切なオプションを選択してください。  
  
注: 正解は 1 点です。  
  
![](https://img.examtopics.com/sc-200/image157.png)

**正解:** ![](https://img.examtopics.com/sc-200/image158.png)

**解説:**
### クエリの論理と最適化のポイント

このクエリを最適化するための鍵は、**「データの絞り込みをできるだけ早い段階で行う」**ことと**「結合（Join）する右側のテーブルを事前にフィルタリングする」**ことです。

- **時間による早期フィルタリング (ボックス 1)**: KQL では、クエリの最初に `| where Timestamp > ago(1h)` を配置することで、処理対象となる `EmailAttachmentInfo` のレコード数を即座に最小限に抑えることができます。これにより、その後の文字列比較（Subject や FileName）の負荷が軽減されます。
    
- **結合の最適化 (ボックス 2)**: `DeviceFileEvents` テーブルは非常に巨大になる可能性があるため、そのまま結合するとパフォーマンスが著しく低下します。
    
    - `join kind=inner (...)` の中でサブクエリを使用して、結合前に `DeviceFileEvents` 側も「過去1時間」に絞り込むのが KQL のベストプラクティスです。
        
    - `SHA256` ハッシュ値をキーとして使用することで、メールの添付ファイルとデバイス上でのファイルイベントを正確に紐付けることができます。